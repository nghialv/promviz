graphName: AbemaTV
clusters:
  - name: abema-prd
    serviceConnections:
      - name: http
        query: status:http_microservice_requests_total:rate2m
        prometheusURL: http://10.8.6.170:9090
        source:
          replacement: INTERNET
        target:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
          class: http
        status:
          label: status
          dangerRegex: ^5..$
        notices:
          - name: highErrorRate
            statusType: danger
            threshold: 0.01
            title: HighErrorRate
      - name: grpc
        query: client_code:grpc_server_requests_total:rate2m{client_host_service!=""}
        prometheusURL: http://10.8.7.37:9090
        source:
          label: client_host_service
        target:
          label: service
          regex: ^abema-(.+)$
          replacement: $1
          class: grpc
        status:
          label: code
          dangerRegex: Internal
          warningRegex: Unavailable|DataLoss
      - name: redis
        query: status:abema_redis_client_cmds_total:rate2m
        prometheusURL: http://10.8.10.134:9090
        source:
          label: service
          regex: ^abema-(?:(ccu-exporter)|(?:(.*)-exporter|(.*)))$
          replacement: $1$2$3
        target:
          label: client
          class: redis
        status:
          label: status
          dangerRegex: failed
    serviceNotices:
      - name: RedisHighErrorRate
        title: High error rate
        severity: 1
        link: http://10.8.10.134:9090
        query: sum by (client)(status:abema_redis_client_cmds_total:rate2m{status="redis_nil"}) > 0
        prometheusURL: http://10.8.10.134:9090
        node:
          label: client

clusterConnections:
  - name: internet-to-abema-prd
    query: sum by (status) (status:http_microservice_requests_total:rate2m)
    prometheusURL: http://10.8.6.170:9090
    source:
      replacement: INTERNET
    target:
      replacement: abema-prd
    status:
      label: status
      dangerRegex: ^5..$
  - name: internet-to-abema-transcoder
    query: sum by (status) (status:http_microservice_requests_total:rate2m)
    prometheusURL: http://10.8.6.170:9090
    source:
      replacement: INTERNET
    target:
      replacement: abema-transcoder
    status:
      label: status
      dangerRegex: ^5..$
  - name: internet-to-bucketeer
    query: sum by (status) (status:http_microservice_requests_total:rate2m)
    prometheusURL: http://10.8.6.170:9090
    source:
      replacement: INTERNET
    target:
      replacement: bucketeer
    status:
      label: status
      dangerRegex: ^5..$

classes:
  - name: http
    color: rgb(100, 100, 255)
  - name: grpc
    color: rgb(128, 128, 128)