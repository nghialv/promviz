graphName: AbemaTV

globalLevel:
  maxVolumeRate: 0.67
  clusterConnections:
    - name: cluster
      query: sum by (status) (status:http_microservice_requests_total:rate2m)
      prometheusURL: http://10.83.254.213:9090
      source:
        replacement: INTERNET
      target:
        replacement: abema-prd
      status:
        label: status
        warningRegex: ^4..$
        dangerRegex: ^5..$

clusterLevel:
  - cluster: abema-prd
    maxVolumeRate: 0.2
    serviceConnections:
      - name: http
        query: status:http_microservice_requests_total:rate2m{service!="abema-web-backend"}
        prometheusURL: http://10.83.254.213:9090
        source:
          replacement: INTERNET
          class: entry
        target:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
          class: http-server
        status:
          label: status
          warningRegex: ^4..$
          dangerRegex: ^5..$
        notices:
          - name: HighErrorRate
            title: "[{{ .value }}] HighErrorRate"
            statusType: danger
            severityThreshold:
              warning: 0.00001
              error: 0.002
      - name: http-web-backend
        query: status:http_microservice_requests_total:rate2m{service="abema-web-backend"}
        prometheusURL: http://10.83.254.213:9090
        source:
          replacement: web
        target:
          replacement: web-backend
        status:
          label: status
          warningRegex: ^4..$
          dangerRegex: ^5..$
      - name: nginx
        query: status:nginx_http_requests_total:rate2m
        prometheusURL: http://10.83.254.213:9090
        source:
          replacement: INTERNET
        target:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
          class: http-server
        status:
          label: status
          warningRegex: ^4..$
          dangerRegex: ^5..$
      - name: grpc
        query: client_code:grpc_server_requests_total:rate2m{client_host_service!=""}
        prometheusURL: http://10.83.253.14:9090
        source:
          label: client_host_service
        target:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
          class: grpc-server
        status:
          label: code
          dangerRegex: Internal
          warningRegex: Unavailable|DataLoss
      - name: redis
        query: status:abema_redis_client_cmds_total:rate2m / 6
        prometheusURL: http://10.83.255.126:9090
        source:
          label: service
          regex: ^abema-(?:(ccu-exporter)|(watchtime-ccu-exporter)|(?:(.*)-exporter|(.*)))$
          replacement: $1$2$3$4
        target:
          label: client
          class: redis
        status:
          label: status
          dangerRegex: failed
      - name: mongodb
        query: client:abema_mongodb_sent_ops_total:rate2m
        prometheusURL: http://10.83.255.126:9090
        source:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
        target:
          label: client
          class: mongodb
      - name: glasgow
        query: status:abema_glasgow_client_requests_total:rate2m
        prometheusURL: http://10.83.255.126:9090
        source:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
        target:
          replacement: GLASGOW
          class: external
        status:
          label: status
          dangerRegex: failed
      - name: gcs
        query: status:abema_gcs_client_requests_total:rate2m
        prometheusURL: http://10.83.255.126:9090
        source:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
        target:
          replacement: GCS
          class: gcp
        status:
          label: status
          dangerRegex: ErrUnknown|failed
      - name: pubsub
        query: service:abema_pubsub_publisher_sent_total:rate2m / 10
        prometheusURL: http://10.83.255.126:9090
        source:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
        target:
          replacement: PUBSUB
          class: gcp
    serviceNotices:
      - name: HttpHighErrorRate
        title: "[{{ .value }}] HighErrorRate - {{ .handler }}"
        query: handler:http_microservice_request_4xx_error_percent:rate2m{service="abema-gateway-exporter"} >= 0
        prometheusURL: http://10.83.254.213:9090
        severityThreshold:
          warning: 0.00001
          error: 0.002
        node:
          label: service
          regex: ^abema-(?:(.*)-exporter|(.*))$
          replacement: $1$2
      - name: RedisHighErrorRate
        title: "[{{ .value }}] HighErrorRate"
        severityThreshold:
          warning: 0.00001
          error: 0.002
        query: sum by (client) (status:abema_redis_client_cmds_total:rate2m{status="redis_nil"}) > 0
        prometheusURL: http://10.83.255.126:9090
        node:
          label: client

classes:
  - name: default
    color: rgb(128, 128, 150)
  - name: entry
    color: rgb(186, 213, 237)
  - name: http-server
    color: rgb(186, 213, 237)
  - name: grpc-server
    color: rgb(186, 213, 237)
  - name: redis
    color: rgb(128, 128, 128)
  - name: mongodb
    color: rgb(128, 128, 128)
  - name: gcp
    color: rgb(128, 150, 128)
  - name: external
    color: rgb(128, 150, 128)